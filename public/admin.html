<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FoodNow - –ü–∞–Ω–µ–ª—å –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.js' integrity='sha512-+k1pnlgt4F1H8L7t3z95o3/KO+o78INEcXTbnoJQ/F2VqDVhWoaiVml/OEHv9HsVgxUaVW+IbiZPUJQfF/YxZw==' crossorigin='anonymous'></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script><script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="container">
    <h2>üìã –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è</h2>
    <div id="ordersContainer"></div>
  </div>
<form id="addMenuItemForm">
  <input type="text" id="itemName" placeholder="–ù–∞–∑–≤–∞" required>
  <input type="text" id="itemDescription" placeholder="–û–ø–∏—Å" required>
  <input type="number" id="itemPrice" placeholder="–¶—ñ–Ω–∞ (–≥—Ä–Ω)" required>
  <input type="text" id="itemImage" placeholder="URL –∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è" value="/api/placeholder/200/120">
  <select id="itemCategory" required>
    <option value="pizza">–ü—ñ—Ü–∞</option>
    <option value="burger">–ë—É—Ä–≥–µ—Ä–∏</option>
    <option value="drink">–ù–∞–ø–æ—ó</option>
  </select>
  <button type="submit">–î–æ–¥–∞—Ç–∏</button>
</form>
  <script>
    const tg = window.Telegram.WebApp;
    tg.expand();

    const adminId = new URLSearchParams(window.location.search).get("adminId");

    function loadOrders() {
      $.get(`/orders?adminId=${adminId}`, (orders) => {
        const container = $("#ordersContainer");
        container.empty();
        orders.forEach(order => {
          const itemsList = order.items.map(item => `${item.name} x${item.quantity} - ${item.price * item.quantity} –≥—Ä–Ω`).join("<br>");
          const card = `
            <div class="order-card">
              <h3>–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥ @${order.userName} (ID: ${order.chatId})</h3>
              <p><strong>–ß–∞—Å:</strong> ${new Date(order.dateTime).toLocaleString()}</p>
              <p><strong>–¢–æ–≤–∞—Ä–∏:</strong><br>${itemsList}</p>
              <p><strong>–°—É–º–∞:</strong> ${order.total} –≥—Ä–Ω</p>
              <p><strong>–°—Ç–∞—Ç—É—Å:</strong>
                <select class="status-select" data-id="${order._id}">
                  <option value="–û—á—ñ–∫—É—î—Ç—å—Å—è" ${order.status === "–û—á—ñ–∫—É—î—Ç—å—Å—è" ? "selected" : ""}>–û—á—ñ–∫—É—î—Ç—å—Å—è</option>
                  <option value="–û–ø—Ä–∞—Ü—å–æ–≤—É—î—Ç—å—Å—è" ${order.status === "–û–ø—Ä–∞—Ü—å–æ–≤—É—î—Ç—å—Å—è" ? "selected" : ""}>–û–ø—Ä–∞—Ü—å–æ–≤—É—î—Ç—å—Å—è</option>
                  <option value="–í–∏–∫–æ–Ω–∞–Ω–æ" ${order.status === "–í–∏–∫–æ–Ω–∞–Ω–æ" ? "selected" : ""}>–í–∏–∫–æ–Ω–∞–Ω–æ</option>
                </select>
              </p>
            </div>
          `;
          container.append(card);
        });

        $(".status-select").change(function() {
          const orderId = $(this).data("id");
          const newStatus = $(this).val();
          $.ajax({
            url: `/orders/${orderId}`,
            method: "PATCH",
            contentType: "application/json",
            data: JSON.stringify({ adminId, status: newStatus }),
            success: () => alert("–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ!"),
            error: (err) => alert("–ü–æ–º–∏–ª–∫–∞: " + err.responseJSON.error),
          });
        });
      });
    }

    $(document).ready(() => {
      loadOrders();
      setInterval(loadOrders, 30000); 
    });



    $("#addMenuItemForm").submit((e) => {
  e.preventDefault();
  const newItem = {
    adminId,
    name: $("#itemName").val(),
    description: $("#itemDescription").val(),
    price: parseInt($("#itemPrice").val()),
    image: $("#itemImage").val(),
    category: $("#itemCategory").val()
  };
  $.ajax({
    url: "/menu",
    method: "POST",
    contentType: "application/json",
    data: JSON.stringify(newItem),
    success: () => {
      alert("–°—Ç—Ä–∞–≤—É –¥–æ–¥–∞–Ω–æ!");
      $("#addMenuItemForm")[0].reset();
    },
    error: (err) => alert("–ü–æ–º–∏–ª–∫–∞: " + err.responseJSON.error)
  });
});
  </script>
</body>
</html>